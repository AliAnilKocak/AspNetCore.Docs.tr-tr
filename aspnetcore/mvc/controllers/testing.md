---
title: ASP.NET Core denetleyicisi mantıksal test
author: ardalis
description: ASP.NET Core Moq ve xUnit ile test denetleyicisi mantıksal öğrenin.
ms.author: riande
ms.date: 10/14/2016
uid: mvc/controllers/testing
ms.openlocfilehash: d0b2a25d00187c088671be147844aa892f824c6e
ms.sourcegitcommit: 64c2ca86fff445944b155635918126165ee0f8aa
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 08/18/2018
ms.locfileid: "41755678"
---
# <a name="test-controller-logic-in-aspnet-core"></a><span data-ttu-id="2c220-103">ASP.NET Core denetleyicisi mantıksal test</span><span class="sxs-lookup"><span data-stu-id="2c220-103">Test controller logic in ASP.NET Core</span></span>

<span data-ttu-id="2c220-104">Tarafından [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="2c220-104">By [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="2c220-105">Denetleyicileri, herhangi bir ASP.NET Core MVC uygulaması, merkezi bir parçasıdır.</span><span class="sxs-lookup"><span data-stu-id="2c220-105">Controllers are a central part of any ASP.NET Core MVC application.</span></span> <span data-ttu-id="2c220-106">Bu nedenle, uygulamanız için tasarlandığı gibi davranırlar güven olması gerekir.</span><span class="sxs-lookup"><span data-stu-id="2c220-106">As such, you should have confidence they behave as intended for your app.</span></span> <span data-ttu-id="2c220-107">Otomatikleştirilmiş testleri Bu güvenle sağlayabilir ve üretime ulaşmadan önce hatalar da algılanabilir.</span><span class="sxs-lookup"><span data-stu-id="2c220-107">Automated tests can provide you with this confidence and can detect errors before they reach production.</span></span> <span data-ttu-id="2c220-108">Gereksiz sorumlulukları denetleyicilerinizi içinde yerleştirmekten kaçının ve denetleyici sorumlulukları yalnızca, testleri odaklanan sağlamak önemlidir.</span><span class="sxs-lookup"><span data-stu-id="2c220-108">It's important to avoid placing unnecessary responsibilities within your controllers and ensure your tests focus only on controller responsibilities.</span></span>

<span data-ttu-id="2c220-109">Denetleyici mantığı en az olmalıdır ve iş mantığı ya da altyapı olarak ilk (örneğin, veri erişimi) odaklı olmayan.</span><span class="sxs-lookup"><span data-stu-id="2c220-109">Controller logic should be minimal and not be focused on business logic or infrastructure concerns (for example, data access).</span></span> <span data-ttu-id="2c220-110">Denetleyici mantığı, framework test edin.</span><span class="sxs-lookup"><span data-stu-id="2c220-110">Test controller logic, not the framework.</span></span> <span data-ttu-id="2c220-111">Test nasıl denetleyici *davranışını* geçerli ya da geçersiz girişler temelinde.</span><span class="sxs-lookup"><span data-stu-id="2c220-111">Test how the controller *behaves* based on valid or invalid inputs.</span></span> <span data-ttu-id="2c220-112">Denetleyici yanıtları gerçekleştirdiği iş işleminin sonucuna dayalı test edin.</span><span class="sxs-lookup"><span data-stu-id="2c220-112">Test controller responses based on the result of the business operation it performs.</span></span>

<span data-ttu-id="2c220-113">Tipik denetleyicisi sorumlulukları:</span><span class="sxs-lookup"><span data-stu-id="2c220-113">Typical controller responsibilities:</span></span>

* <span data-ttu-id="2c220-114">Doğrulama `ModelState.IsValid`.</span><span class="sxs-lookup"><span data-stu-id="2c220-114">Verify `ModelState.IsValid`.</span></span>
* <span data-ttu-id="2c220-115">Bir hata yanıtı döndürür `ModelState` geçersiz.</span><span class="sxs-lookup"><span data-stu-id="2c220-115">Return an error response if `ModelState` is invalid.</span></span>
* <span data-ttu-id="2c220-116">Bir iş varlığı Kalıcılık alın.</span><span class="sxs-lookup"><span data-stu-id="2c220-116">Retrieve a business entity from persistence.</span></span>
* <span data-ttu-id="2c220-117">İş varlıkta bir eylem gerçekleştirin.</span><span class="sxs-lookup"><span data-stu-id="2c220-117">Perform an action on the business entity.</span></span>
* <span data-ttu-id="2c220-118">İş varlığı için Kalıcılık kaydedin.</span><span class="sxs-lookup"><span data-stu-id="2c220-118">Save the business entity to persistence.</span></span>
* <span data-ttu-id="2c220-119">Uygun bir dönüş `IActionResult`.</span><span class="sxs-lookup"><span data-stu-id="2c220-119">Return an appropriate `IActionResult`.</span></span>

<span data-ttu-id="2c220-120">[Görüntüleme veya indirme örnek kodu](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([nasıl indirileceğini](xref:tutorials/index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="2c220-120">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="unit-tests-of-controller-logic"></a><span data-ttu-id="2c220-121">Denetleyici mantıksal birim testleri</span><span class="sxs-lookup"><span data-stu-id="2c220-121">Unit tests of controller logic</span></span>

<span data-ttu-id="2c220-122">[Birim testleri](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) bir uygulamanın bir parçası, altyapısını ve bağımlılıklarını yalıtımdan test içerir.</span><span class="sxs-lookup"><span data-stu-id="2c220-122">[Unit tests](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) involve testing a part of an app in isolation from its infrastructure and dependencies.</span></span> <span data-ttu-id="2c220-123">Birim testi denetleyicisi mantığı, yalnızca tek bir eylem içeriği ne zaman sınanırken, olmayan davranış framework'ün ya da bağımlılıklarından biri.</span><span class="sxs-lookup"><span data-stu-id="2c220-123">When unit testing controller logic, only the contents of a single action is tested, not the behavior of its dependencies or of the framework itself.</span></span> <span data-ttu-id="2c220-124">Test denetleyicisi eylemlerinizi, birimi, yalnızca davranışını üzerinde odaklanın emin olun.</span><span class="sxs-lookup"><span data-stu-id="2c220-124">As you unit test your controller actions, make sure you focus only on its behavior.</span></span> <span data-ttu-id="2c220-125">Bir denetleyici birim testi gibi şeyleri önler [filtreleri](xref:mvc/controllers/filters), [yönlendirme](xref:fundamentals/routing), veya [model bağlama](xref:mvc/models/model-binding).</span><span class="sxs-lookup"><span data-stu-id="2c220-125">A controller unit test avoids things like [filters](xref:mvc/controllers/filters), [routing](xref:fundamentals/routing), or [model binding](xref:mvc/models/model-binding).</span></span> <span data-ttu-id="2c220-126">Tek şey sınamalara odaklanarak, birim testleri genellikle basit yazmak ve çalıştırmak hızlı.</span><span class="sxs-lookup"><span data-stu-id="2c220-126">By focusing on testing just one thing, unit tests are generally simple to write and quick to run.</span></span> <span data-ttu-id="2c220-127">Birim testleri iyi-yazılan bir dizi sık kadar ek yük çalıştırabilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="2c220-127">A well-written set of unit tests can be run frequently without much overhead.</span></span> <span data-ttu-id="2c220-128">Ancak, birim testleri sorunları algılama bileşenleri arasındaki etkileşim içinde olan amacı [tümleştirme testleri](xref:test/integration-tests).</span><span class="sxs-lookup"><span data-stu-id="2c220-128">However, unit tests don't detect issues in the interaction between components, which is the purpose of [integration tests](xref:test/integration-tests).</span></span>

<span data-ttu-id="2c220-129">Özel Filtreler ve yollar yazıyorsanız, birim gereken testleri belirli bir denetleyici eylemi bir parçası olarak değil, yalıtım, bunları test edin.</span><span class="sxs-lookup"><span data-stu-id="2c220-129">If you're writing custom filters and routes, you should unit test them in isolation, not as part of your tests on a particular controller action.</span></span>

> [!TIP]
> <span data-ttu-id="2c220-130">[Oluşturma ve birim testlerini Visual Studio ile çalıştırma](/visualstudio/test/unit-test-your-code).</span><span class="sxs-lookup"><span data-stu-id="2c220-130">[Create and run unit tests with Visual Studio](/visualstudio/test/unit-test-your-code).</span></span>

<span data-ttu-id="2c220-131">Birim testi göstermek için aşağıdaki denetleyicisi gözden geçirin.</span><span class="sxs-lookup"><span data-stu-id="2c220-131">To demonstrate unit testing, review the following controller.</span></span> <span data-ttu-id="2c220-132">Oturumlarının fırtınası listesini görüntüler ve yeni bir GÖNDERİ ile oluşturulacak oturumları fırtınası sağlar:</span><span class="sxs-lookup"><span data-stu-id="2c220-132">It displays a list of brainstorming sessions and allows new brainstorming sessions to be created with a POST:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/HomeController.cs?highlight=12,16,21,42,43)]

<span data-ttu-id="2c220-133">Denetleyici aşağıdaki [özel bağımlılıklar İlkesi](http://deviq.com/explicit-dependencies-principle/), bağımlılık ekleme örneği ile sağlamak için bekleniyor `IBrainstormSessionRepository`.</span><span class="sxs-lookup"><span data-stu-id="2c220-133">The controller is following the [explicit dependencies principle](http://deviq.com/explicit-dependencies-principle/), expecting dependency injection to provide it with an instance of `IBrainstormSessionRepository`.</span></span> <span data-ttu-id="2c220-134">Bu oldukça, sahte nesne çerçeve gibi kullanarak test etmek kolaylaştırır [Moq](https://www.nuget.org/packages/Moq/).</span><span class="sxs-lookup"><span data-stu-id="2c220-134">This makes it fairly easy to test using a mock object framework, like [Moq](https://www.nuget.org/packages/Moq/).</span></span> <span data-ttu-id="2c220-135">`HTTP GET Index` Yöntemi hiçbir döngü ya da dallanma ve yalnızca çağrıları bir yöntemi vardır.</span><span class="sxs-lookup"><span data-stu-id="2c220-135">The `HTTP GET Index` method has no looping or branching and only calls one method.</span></span> <span data-ttu-id="2c220-136">Bunu test etmek için `Index` yöntemi ihtiyacımız doğrulamak bir `ViewResult` döndürülecek ile bir `ViewModel` deponun gelen `List` yöntemi.</span><span class="sxs-lookup"><span data-stu-id="2c220-136">To test this `Index` method, we need to verify that a `ViewResult` is returned, with a `ViewModel` from the repository's `List` method.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=17-18&range=1-33,76-95)]

<span data-ttu-id="2c220-137">`HomeController` `HTTP POST Index` Yöntemini (yukarıda gösterilmiştir) doğrulayın:</span><span class="sxs-lookup"><span data-stu-id="2c220-137">The `HomeController` `HTTP POST Index` method (shown above) should verify:</span></span>

* <span data-ttu-id="2c220-138">Hatalı istek eylem yöntemine döndürür `ViewResult` uygun verileri ile zaman `ModelState.IsValid` olduğu `false`.</span><span class="sxs-lookup"><span data-stu-id="2c220-138">The action method returns a Bad Request `ViewResult` with the appropriate data when `ModelState.IsValid` is `false`.</span></span>

* <span data-ttu-id="2c220-139">`Add` Deposunda yöntemi çağrılır ve bir `RedirectToActionResult` doğru bağımsız değişkenleri ile döndürülen zaman `ModelState.IsValid` geçerlidir.</span><span class="sxs-lookup"><span data-stu-id="2c220-139">The `Add` method on the repository is called and a `RedirectToActionResult` is returned with the correct arguments when `ModelState.IsValid` is true.</span></span>

<span data-ttu-id="2c220-140">Geçersiz model durumu hataları kullanarak ekleyerek edilebilirler `AddModelError` ilk test aşağıda gösterildiği gibi.</span><span class="sxs-lookup"><span data-stu-id="2c220-140">Invalid model state can be tested by adding errors using `AddModelError` as shown in the first test below.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=8,15-16,37-39&range=35-75)]

<span data-ttu-id="2c220-141">İlk testin ne zaman onaylar `ModelState` geçersiz, aynı `ViewResult` olarak için döndürülen bir `GET` istek.</span><span class="sxs-lookup"><span data-stu-id="2c220-141">The first test confirms when `ModelState` isn't valid, the same `ViewResult` is returned as for a `GET` request.</span></span> <span data-ttu-id="2c220-142">Test geçersiz bir modelde geçirilecek çalışmaz unutmayın.</span><span class="sxs-lookup"><span data-stu-id="2c220-142">Note that the test doesn't attempt to pass in an invalid model.</span></span> <span data-ttu-id="2c220-143">Bu mıydı işe yine de model bağlama çalışmadığından bu yana (ancak bir [tümleştirme test](xref:test/integration-tests) alıştırma model bağlama kullanırsınız).</span><span class="sxs-lookup"><span data-stu-id="2c220-143">That wouldn't work anyway since model binding isn't running (though an [integration test](xref:test/integration-tests) would use exercise model binding).</span></span> <span data-ttu-id="2c220-144">Bu durumda, model bağlama test edilen değil.</span><span class="sxs-lookup"><span data-stu-id="2c220-144">In this case, model binding isn't being tested.</span></span> <span data-ttu-id="2c220-145">Bu birim testlerini, yalnızca ne yaptığını kodda bir eylem yöntemi test edersiniz.</span><span class="sxs-lookup"><span data-stu-id="2c220-145">These unit tests are only testing what the code in the action method does.</span></span>

<span data-ttu-id="2c220-146">O zaman ikinci test doğrular `ModelState` geçerli olduğu yeni bir `BrainstormSession` (depo) eklenir ve yöntemi bir `RedirectToActionResult` beklenen özelliklere sahip.</span><span class="sxs-lookup"><span data-stu-id="2c220-146">The second test verifies that when `ModelState` is valid, a new `BrainstormSession` is added (via the repository), and the method returns a `RedirectToActionResult` with the expected properties.</span></span> <span data-ttu-id="2c220-147">Adı olmayan sahte çağrıları normalde yoksayıldı, ancak arama `Verifiable` Kurulum sonunda çağrı testinde doğrulanması izin verir.</span><span class="sxs-lookup"><span data-stu-id="2c220-147">Mocked calls that aren't called are normally ignored, but calling `Verifiable` at the end of the setup call allows it to be verified in the test.</span></span> <span data-ttu-id="2c220-148">Bu çağrı yapılır `mockRepo.Verify`, hangi başarısız olur test beklenen yöntemi çağrılırsa değildi.</span><span class="sxs-lookup"><span data-stu-id="2c220-148">This is done with the call to `mockRepo.Verify`, which will fail the test if the expected method wasn't called.</span></span>

> [!NOTE]
> <span data-ttu-id="2c220-149">Bu örnekte kullanılan Moq kitaplığı doğrulanabilir ya da "strict" mocks doğrulanamaz mocks ("belirsiz" mocks veya yer tutucular olarak da bilinir) ile karıştırmak kolaylaştırır.</span><span class="sxs-lookup"><span data-stu-id="2c220-149">The Moq library used in this sample makes it easy to mix verifiable, or "strict", mocks with non-verifiable mocks (also called "loose" mocks or stubs).</span></span> <span data-ttu-id="2c220-150">Daha fazla bilgi edinin [Moq ile sahte davranışını özelleştirme](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span><span class="sxs-lookup"><span data-stu-id="2c220-150">Learn more about [customizing Mock behavior with Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span></span>

<span data-ttu-id="2c220-151">Başka bir denetleyici uygulamasında belirli fırtınası oturumuyla ilgili bilgileri görüntüler.</span><span class="sxs-lookup"><span data-stu-id="2c220-151">Another controller in the app displays information related to a particular brainstorming session.</span></span> <span data-ttu-id="2c220-152">Geçersiz kod değerleri ile dağıtılacak mantığa aşağıdakileri içerir:</span><span class="sxs-lookup"><span data-stu-id="2c220-152">It includes some logic to deal with invalid id values:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/SessionController.cs?highlight=19,20,21,22,25,26,27,28)]

<span data-ttu-id="2c220-153">Denetleyici eylemini test etmek için her biri üç durumda olan `return` deyimi:</span><span class="sxs-lookup"><span data-stu-id="2c220-153">The controller action has three cases to test, one for each `return` statement:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/SessionControllerTests.cs?highlight=27,28,29,46,47,64,65,66,67,68)]

<span data-ttu-id="2c220-154">Uygulama bir web API (fırtınası oturumu ve bir oturumu yeni fikirler eklemek için bir yöntem ile ilgili fikirlerinizi listesi) işlevselliği kullanıma sunar:</span><span class="sxs-lookup"><span data-stu-id="2c220-154">The app exposes functionality as a web API (a list of ideas associated with a brainstorming session and a method for adding new ideas to a session):</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Api/IdeasController.cs?highlight=21,22,27,30,31,32,33,34,35,36,41,42,46,52,65)]

<span data-ttu-id="2c220-155">`ForSession` Yöntemi listesini döndürür `IdeaDTO` türleri.</span><span class="sxs-lookup"><span data-stu-id="2c220-155">The `ForSession` method returns a list of `IdeaDTO` types.</span></span> <span data-ttu-id="2c220-156">İş etki alanı varlıklarınızı doğrudan API çağrıları geri dönmekten kaçının, API istemcisi gerektirir ve bunlar gereksiz yere uygulamanızın iç etki alanı modeli, harici olarak kullanıma API ile eşleştiği daha fazla veri beri sık içerirler.</span><span class="sxs-lookup"><span data-stu-id="2c220-156">Avoid returning your business domain entities directly via API calls, since frequently they include more data than the API client requires, and they unnecessarily couple your app's internal domain model with the API you expose externally.</span></span> <span data-ttu-id="2c220-157">Etki alanı varlıklarının kablo üzerinden döndürecektir türleri arasında eşleme el ile yapılabilir (bir LINQ kullanarak `Select` burada gösterildiği gibi) veya benzer bir kitaplık kullanılarak [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span><span class="sxs-lookup"><span data-stu-id="2c220-157">Mapping between domain entities and the types you will return over the wire can be done manually (using a LINQ `Select` as shown here) or using a library like [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span></span>

<span data-ttu-id="2c220-158">Birim testleri için `Create` ve `ForSession` API yöntemleri:</span><span class="sxs-lookup"><span data-stu-id="2c220-158">The unit tests for the `Create` and `ForSession` API methods:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/ApiIdeasControllerTests.cs?highlight=18,23,29,33,38-39,43,50,58-59,68-70,76-78&range=1-83,121-135)]

<span data-ttu-id="2c220-159">Yöntemin davranışını test etmek için daha önce belirtildiği gibi `ModelState` geçersiz model hatası denetleyiciye testin bir parçası ekleyin.</span><span class="sxs-lookup"><span data-stu-id="2c220-159">As stated previously, to test the behavior of the method when `ModelState` is invalid, add a model error to the controller as part of the test.</span></span> <span data-ttu-id="2c220-160">Model doğrulama veya model bağlama birim testlerinizde test-yalnızca belirli bir ile karşılaşıldığında, eylem yöntemin davranışını test çalışmayın `ModelState` değeri.</span><span class="sxs-lookup"><span data-stu-id="2c220-160">Don't try to test model validation or model binding in your unit tests - just test your action method's behavior when confronted with a particular `ModelState` value.</span></span>

<span data-ttu-id="2c220-161">İkinci test sahte deposunun null döndürmek üzere yapılandırıldığı şekilde null döndüren havuzda bağlıdır.</span><span class="sxs-lookup"><span data-stu-id="2c220-161">The second test depends on the repository returning null, so the mock repository is configured to return null.</span></span> <span data-ttu-id="2c220-162">Bir test veritabanı oluşturmaya gerek yoktur (bellekte veya başka türlü) ve bu sonuç döndüren bir sorgu oluşturun - bu tek bir deyimde gösterildiği yapılabilir.</span><span class="sxs-lookup"><span data-stu-id="2c220-162">There's no need to create a test database (in memory or otherwise) and construct a query that will return this result - it can be done in a single statement as shown.</span></span>

<span data-ttu-id="2c220-163">Son test doğrular deponun `Update` yöntemi çağrılır.</span><span class="sxs-lookup"><span data-stu-id="2c220-163">The last test verifies that the repository's `Update` method is called.</span></span> <span data-ttu-id="2c220-164">Daha önce yaptığımız gibi sahte çağrılır `Verifiable` ve ardından sahte deponun `Verify` yöntemi doğrulanabilir yöntemi yürütüldü doğrulamak için çağrılır.</span><span class="sxs-lookup"><span data-stu-id="2c220-164">As we did previously, the mock is called with `Verifiable` and then the mocked repository's `Verify` method is called to confirm the verifiable method was executed.</span></span> <span data-ttu-id="2c220-165">Emin olmak için bir birim test sorumluluğu değil `Update` yöntemi kaydedilen verileri; ile bir tümleştirme testi yapılabilir.</span><span class="sxs-lookup"><span data-stu-id="2c220-165">It's not a unit test responsibility to ensure that the `Update` method saved the data; that can be done with an integration test.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="2c220-166">Ek kaynaklar</span><span class="sxs-lookup"><span data-stu-id="2c220-166">Additional resources</span></span>

* <xref:test/integration-tests>
