---
title: ASP.NET Core anahtar yönetimi
author: rick-anderson
description: ASP.NET Core veri koruması anahtar yönetimi API'leri uygulama ayrıntılarını öğrenin.
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: be8597a2522c3145056dee709210de065e8cb593
ms.sourcegitcommit: a1afd04758e663d7062a5bfa8a0d4dca38f42afc
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 06/20/2018
ms.locfileid: "36276637"
---
# <a name="key-management-in-aspnet-core"></a><span data-ttu-id="84bef-103">ASP.NET Core anahtar yönetimi</span><span class="sxs-lookup"><span data-stu-id="84bef-103">Key management in ASP.NET Core</span></span>

<a name="data-protection-implementation-key-management"></a>

<span data-ttu-id="84bef-104">Veri koruma sistemi otomatik olarak korumak ve yükü korumasını kaldırmak için kullanılan ana anahtarları ömrü yönetir.</span><span class="sxs-lookup"><span data-stu-id="84bef-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="84bef-105">Her anahtar dört aşamaları biri bulunamaz:</span><span class="sxs-lookup"><span data-stu-id="84bef-105">Each key can exist in one of four stages:</span></span>

* <span data-ttu-id="84bef-106">Oluşturulan - anahtar anahtar halka var, ancak henüz etkinleştirilmedi.</span><span class="sxs-lookup"><span data-stu-id="84bef-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="84bef-107">Yeterli süre dolduktan kadar anahtar için bu anahtar halkası kullanan tüm makineler yaymak için bir fırsat oluşmuş anahtar yeni koruma işlemleri için kullanılmamalıdır.</span><span class="sxs-lookup"><span data-stu-id="84bef-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="84bef-108">Etkin - anahtar anahtar halka var ve tüm yeni koruma işlemler için kullanılmalıdır.</span><span class="sxs-lookup"><span data-stu-id="84bef-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="84bef-109">Süresi - anahtar doğal yaşam çalıştırıldı ve yeni koruma işlemler için artık kullanılmalıdır.</span><span class="sxs-lookup"><span data-stu-id="84bef-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="84bef-110">İptal - anahtar güvenliği aşıldığında ve yeni koruma işlemleri için kullanılmamalıdır.</span><span class="sxs-lookup"><span data-stu-id="84bef-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="84bef-111">Oluşturulan, etkin ve süresi dolan anahtarlar tüm gelen yükü korumasını kaldırmak için kullanılabilir.</span><span class="sxs-lookup"><span data-stu-id="84bef-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="84bef-112">Varsayılan iptal edilen anahtarları yükü korumasını kaldırmak için kullanılamaz, ancak uygulama geliştiricisi için [bu davranışı geçersiz kılma](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) gerekiyorsa.</span><span class="sxs-lookup"><span data-stu-id="84bef-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="84bef-113">Geliştirici (örn., karşılık gelen dosyasını dosya sisteminden silerek) anahtarı halka dışında bir anahtarı silmek için gerekebilir.</span><span class="sxs-lookup"><span data-stu-id="84bef-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="84bef-114">Bu noktada, anahtar tarafından korunan tüm verileri kalıcı olarak undecipherable ve iptal edilen anahtarlarla gibi Acil geçersiz kılma yok.</span><span class="sxs-lookup"><span data-stu-id="84bef-114">At that point, all data protected by the key is permanently undecipherable, and there's no emergency override like there's with revoked keys.</span></span> <span data-ttu-id="84bef-115">Bir anahtarı silme gerçekten bozucu davranıştır ve sonuç olarak bu işlemi gerçekleştirmek için veri koruma sisteminde birinci sınıf bir API sunar.</span><span class="sxs-lookup"><span data-stu-id="84bef-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="84bef-116">Varsayılan anahtar seçimi</span><span class="sxs-lookup"><span data-stu-id="84bef-116">Default key selection</span></span>

<span data-ttu-id="84bef-117">Veri koruma sisteminde yedekleme depodan anahtar halkası okuduğunda, anahtar halkası "varsayılan" anahtarından bulmaya çalışır.</span><span class="sxs-lookup"><span data-stu-id="84bef-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="84bef-118">Varsayılan anahtar yeni koruma işlemleri için kullanılır.</span><span class="sxs-lookup"><span data-stu-id="84bef-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="84bef-119">Genel buluşsal yöntem, veri koruma sisteminde varsayılan anahtar olarak en son etkinleştirme tarihi anahtarla seçer ' dir.</span><span class="sxs-lookup"><span data-stu-id="84bef-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="84bef-120">(Sunucu sunucu saati eğme izin vermek için bir küçük fudge faktörü yoktur.) Anahtarının süresi doldu veya iptal, anahtar oluşturma ve uygulama otomatik devre dışı ise varsa yeni bir anahtar hemen etkinleştirme oluşturulan [anahtar kullanım süresi sonu ve çalışırken](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) aşağıdaki ilke.</span><span class="sxs-lookup"><span data-stu-id="84bef-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="84bef-121">Veri koruma sisteminde neden hemen yeni bir anahtar oluşturur yerine çok farklı bir anahtarı geri dönmeden yeni anahtar oluşturma önce yeni anahtarı etkinleştirilen tüm anahtarların örtük bir sona erme olarak değerlendirilmelidir.</span><span class="sxs-lookup"><span data-stu-id="84bef-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="84bef-122">Genel yeni anahtarlar farklı algoritmalar veya daha eski anahtarları rest sırasında şifreleme mekanizmaları ile yapılandırılmış olabilir ve sistem yapılandırmasına geri dönmeden tercih etmelisiniz olur.</span><span class="sxs-lookup"><span data-stu-id="84bef-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="84bef-123">Bir istisna vardır.</span><span class="sxs-lookup"><span data-stu-id="84bef-123">There's an exception.</span></span> <span data-ttu-id="84bef-124">Uygulama geliştiricisi varsa [otomatik anahtar oluşturma devre dışı](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), sonra da veri koruma sisteminde varsayılan anahtar olarak bir şey seçmeniz gerekir.</span><span class="sxs-lookup"><span data-stu-id="84bef-124">If the application developer has [disabled automatic key generation](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="84bef-125">Geri dönüş Bu senaryoda, sistem, kümedeki diğer makinelere yaymak için bir süre beklendiğinden anahtarlarına verilen tercih ile en son etkinleştirme tarihi olmayan iptal anahtarla seçeceksiniz.</span><span class="sxs-lookup"><span data-stu-id="84bef-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="84bef-126">Geri dönüş sistemi, süresi dolan varsayılan anahtar sonucunda seçme bitebilir.</span><span class="sxs-lookup"><span data-stu-id="84bef-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="84bef-127">Geri dönüş sistemi varsayılan anahtar olarak iptal edilen bir anahtar asla seçin ve ardından anahtar halkası boşsa veya her anahtarı iptal sistem başlatma sırasında bir hata oluşturur.</span><span class="sxs-lookup"><span data-stu-id="84bef-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="84bef-128">Anahtar kullanım süresi sonu ve çalışırken</span><span class="sxs-lookup"><span data-stu-id="84bef-128">Key expiration and rolling</span></span>

<span data-ttu-id="84bef-129">Bir anahtar oluşturduğunuzda, bir etkinleştirme tarihi {şimdi + 2 gün} ve {şimdi + 90 gün} bir sona erme tarihini otomatik olarak verdiği.</span><span class="sxs-lookup"><span data-stu-id="84bef-129">When a key is created, it's automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="84bef-130">Etkinleştirme 2 gün gecikme sisteminde yaymak için anahtar zaman verir.</span><span class="sxs-lookup"><span data-stu-id="84bef-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="84bef-131">Diğer bir deyişle, böylece anahtar halka yayılan olur mu etkin gerekebilecek tüm uygulamaların bunu kullanmanızı olasılığını en üst düzeye çıkarma kendi sonraki otomatik yenileme dönemi sırasında anahtar izlemek yedekleme mağazada işaret eden diğer uygulamaların izin verir.</span><span class="sxs-lookup"><span data-stu-id="84bef-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="84bef-132">Varsayılan anahtar 2 gün içinde sona erecek ve anahtar halkası varsayılan anahtar sona erme sonra etkin olacak bir anahtar zaten yoksa, veri koruma sistemi otomatik olarak yeni bir anahtar halkası anahtara korunur.</span><span class="sxs-lookup"><span data-stu-id="84bef-132">If the default key will expire within 2 days and if the key ring doesn't already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="84bef-133">Bu yeni anahtarı etkinleştirme tarihi {varsayılan anahtarın sona erme tarihi} ve {şimdi + 90 gün} bir sona erme tarihi vardır.</span><span class="sxs-lookup"><span data-stu-id="84bef-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="84bef-134">Bu anahtarlar düzenli olarak hizmet kesintisine neden olmadan otomatik olarak geri dönmek sistem sağlar.</span><span class="sxs-lookup"><span data-stu-id="84bef-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="84bef-135">Bir anahtar ile hemen etkinleştirme oluşturulacağı durumlar olabilir.</span><span class="sxs-lookup"><span data-stu-id="84bef-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="84bef-136">Bir örnek uygulama için bir saat çalıştırdığınızda kurmadı ve anahtar halkası tüm anahtarlarında süresi dolmuş olabilir.</span><span class="sxs-lookup"><span data-stu-id="84bef-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="84bef-137">Bu gerçekleştiğinde, anahtar {şimdi} normal 2 gün etkinleştirme gecikme olmadan bir etkinleştirme tarihi verilir.</span><span class="sxs-lookup"><span data-stu-id="84bef-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="84bef-138">Aşağıdaki örnekte olduğu gibi yapılandırılabilir olsa varsayılan anahtar yaşam süresi 90 gün olur.</span><span class="sxs-lookup"><span data-stu-id="84bef-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

<span data-ttu-id="84bef-139">Açık bir çağrı ancak yönetici ayrıca sistem genelinde varsayılan değiştirebilirsiniz `SetDefaultKeyLifetime` tüm sistem genelinde ilkesini geçersiz kılar.</span><span class="sxs-lookup"><span data-stu-id="84bef-139">An administrator can also change the default system-wide, though an explicit call to `SetDefaultKeyLifetime` will override any system-wide policy.</span></span> <span data-ttu-id="84bef-140">Varsayılan anahtar yaşam süresi 7 günden daha kısa olamaz.</span><span class="sxs-lookup"><span data-stu-id="84bef-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-key-ring-refresh"></a><span data-ttu-id="84bef-141">Otomatik anahtar halkası yenileme</span><span class="sxs-lookup"><span data-stu-id="84bef-141">Automatic key ring refresh</span></span>

<span data-ttu-id="84bef-142">Veri koruma sisteminde başlatır, temel alınan depodan anahtar halkası okur ve bellekte önbelleğe alır.</span><span class="sxs-lookup"><span data-stu-id="84bef-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="84bef-143">Bu önbellek yedekleme deposu basarsa olmadan devam etmek koruma ve Unprotect işlemlere izin verir.</span><span class="sxs-lookup"><span data-stu-id="84bef-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="84bef-144">Sistem otomatik olarak yaklaşık 24 saatte bir ya da geçerli varsayılan anahtar sona erdiğinde hangisi önce gelirse yedekleme deposu değişiklikler için kontrol eder.</span><span class="sxs-lookup"><span data-stu-id="84bef-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="84bef-145">Geliştiriciler gereken nadiren (Şimdiye kadar varsa) anahtar yönetimi API'lerini doğrudan kullanmanız gerekir.</span><span class="sxs-lookup"><span data-stu-id="84bef-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="84bef-146">Veri koruma sisteminde, yukarıda açıklandığı gibi otomatik anahtar yönetimi işlemini gerçekleştirecek.</span><span class="sxs-lookup"><span data-stu-id="84bef-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="84bef-147">Veri koruma sisteminde bir arabirimi kullanıma sunan `IKeyManager` inceleyebilir ve anahtar halkası değişiklik yapmak için kullanılabilir.</span><span class="sxs-lookup"><span data-stu-id="84bef-147">The data protection system exposes an interface `IKeyManager` that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="84bef-148">Örneğinin sağlanan dı sistem `IDataProtectionProvider` örneği de sağlayabilirsiniz `IKeyManager` , tüketimi için.</span><span class="sxs-lookup"><span data-stu-id="84bef-148">The DI system that provided the instance of `IDataProtectionProvider` can also provide an instance of `IKeyManager` for your consumption.</span></span> <span data-ttu-id="84bef-149">Alternatif olarak, çekme `IKeyManager` doğrudan gelen `IServiceProvider` aşağıdaki örnekteki.</span><span class="sxs-lookup"><span data-stu-id="84bef-149">Alternatively, you can pull the `IKeyManager` straight from the `IServiceProvider` as in the example below.</span></span>

<span data-ttu-id="84bef-150">Hangi anahtar (yeni bir anahtar açıkça oluşturma veya iptali gerçekleştirme) halkası değiştiren herhangi bir işlem, bellek içi önbellek geçersiz kılar.</span><span class="sxs-lookup"><span data-stu-id="84bef-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="84bef-151">Sonraki çağrı `Protect` veya `Unprotect` anahtar halkası yeniden okuyun ve önbellek yeniden oluşturmak veri koruma sisteminde neden olur.</span><span class="sxs-lookup"><span data-stu-id="84bef-151">The next call to `Protect` or `Unprotect` will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="84bef-152">Aşağıdaki örneği kullanarak gösteren `IKeyManager` inceleyin ve iptal etme ve varolan anahtarları el ile yeni bir anahtar oluşturma dahil olmak üzere anahtar halkası işlemek için arabirim.</span><span class="sxs-lookup"><span data-stu-id="84bef-152">The sample below demonstrates using the `IKeyManager` interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

[!code-csharp[](key-management/samples/key-management.cs)]

## <a name="key-storage"></a><span data-ttu-id="84bef-153">Anahtar depolama</span><span class="sxs-lookup"><span data-stu-id="84bef-153">Key storage</span></span>

<span data-ttu-id="84bef-154">Veri koruma sisteminde alınabildiği bir rest mekanizması şifreleme ve uygun anahtar depolama konumu otomatik olarak türetme için çalışır buluşsal yöntem vardır.</span><span class="sxs-lookup"><span data-stu-id="84bef-154">The data protection system has a heuristic whereby it tries to deduce an appropriate key storage location and encryption at rest mechanism automatically.</span></span> <span data-ttu-id="84bef-155">Bu ayrıca uygulama geliştiricisi tarafından yapılandırılabilir.</span><span class="sxs-lookup"><span data-stu-id="84bef-155">This is also configurable by the app developer.</span></span> <span data-ttu-id="84bef-156">Aşağıdaki belgeler Bu mekanizmaların yerleşik uygulamaları ele alınmıştır:</span><span class="sxs-lookup"><span data-stu-id="84bef-156">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* [<span data-ttu-id="84bef-157">Yerleşik anahtar depolama sağlayıcıları</span><span class="sxs-lookup"><span data-stu-id="84bef-157">In-box key storage providers</span></span>](xref:security/data-protection/implementation/key-storage-providers#data-protection-implementation-key-storage-providers)

* [<span data-ttu-id="84bef-158">Yerleşik rest sağlayıcıları anahtar şifreleme</span><span class="sxs-lookup"><span data-stu-id="84bef-158">In-box key encryption at rest providers</span></span>](xref:security/data-protection/implementation/key-encryption-at-rest#data-protection-implementation-key-encryption-at-rest-providers)
